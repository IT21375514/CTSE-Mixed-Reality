<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Classroom Enhanced</title>
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
    <!-- Particle System Component -->
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-particle-system-component@1.0.1/dist/aframe-particle-system-component.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      canvas { touch-action: none; }
    </style>

    <script>
      // Drag-to-rotate
      AFRAME.registerComponent('drag-rotate', {
        init: function () {
          this.dragging = false; this.prev = {x:0,y:0};
          const c = this.el.sceneEl.canvas;
          const down = e=>{ this.dragging=true; this.prev={x:e.clientX,y:e.clientY}; };
          const up   = ()=>{ this.dragging=false; };
          const mv   = e=> {
            if(!this.dragging) return;
            const dx = e.clientX - this.prev.x;
            this.el.object3D.rotation.y += dx * 0.005;
            this.prev = {x:e.clientX,y:e.clientY};
          };
          c.addEventListener('mousedown', down);
          window.addEventListener('mouseup', up);
          window.addEventListener('mousemove', mv);
          c.addEventListener('touchstart', ev=> down(ev.touches[0]));
          window.addEventListener('touchend', up);
          window.addEventListener('touchmove', ev=> mv(ev.touches[0]));
        }
      });

      // Zoomable by wheel & pinch
      AFRAME.registerComponent('zoomable', {
        init: function () {
          const obj3D = this.el.object3D;
          const c     = this.el.sceneEl.canvas;
          // wheel
          c.addEventListener('wheel', e=>{
            e.preventDefault();
            const f = e.deltaY<0?1.1:0.9;
            obj3D.scale.multiplyScalar(f);
          },{passive:false});
          // pinch
          let lastDist = null;
          c.addEventListener('touchmove', e=>{
            if(e.touches.length!==2){ lastDist=null; return; }
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const d  = Math.hypot(dx,dy);
            if(lastDist) obj3D.scale.multiplyScalar(d/lastDist);
            lastDist=d;
          });
          c.addEventListener('touchend', ()=> lastDist=null);
        }
      });

      // Auto-resume audio
      document.addEventListener('DOMContentLoaded', ()=>{
        const scene = document.querySelector('a-scene');
        scene.addEventListener('loaded', ()=>{
          const ctx = scene.systems.sound.context;
          if(ctx && ctx.state==='suspended') ctx.resume();
        });
      });
    </script>
  </head>

  <body>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false; markersAreaEnabled: true"
      cursor="rayOrigin: mouse"
    >
      <!-- Assets -->
      <a-assets>
        <a-asset-item id="bookModel"   src="models/book.glb"></a-asset-item>
        <a-asset-item id="chairModel"  src="models/chair.glb"></a-asset-item>
        <a-asset-item id="laptopModel" src="models/laptop.glb"></a-asset-item>

        <audio id="pageSound"   src="sounds/page-turn.mp3" preload="auto"></audio>
        <audio id="chairSound"  src="sounds/chair-creak.mp3" preload="auto"></audio>
        <audio id="typingSound" src="sounds/typing.mp3" preload="auto"></audio>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient;  intensity: 0.6"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>

      <!-- BOOK marker: page-turn on markerFound -->
      <a-marker
        id="bookMarker"
        type="pattern"
        url="markers/book.patt"
        emitevents
        smooth="true" smoothCount="10" smoothTolerance="0.01"
        sound="src: #pageSound; on: markerFound; positional: false"
      >
        <a-entity drag-rotate zoomable scale="0.01 0.01 0.01">
          <a-gltf-model src="#bookModel"></a-gltf-model>
        </a-entity>
      </a-marker>

      <!-- CHAIR marker: creak on markerFound -->
      <a-marker
        id="chairMarker"
        type="pattern"
        url="markers/chair.patt"
        emitevents
        smooth="true" smoothCount="10" smoothTolerance="0.01"
        sound="src: #chairSound; on: markerFound; positional: false"
      >
        <a-entity drag-rotate zoomable scale="4 4 4">
          <a-gltf-model src="#chairModel"></a-gltf-model>
        </a-entity>
      </a-marker>

      <!-- LAPTOP marker: typing on click only -->
      <a-marker
        id="laptopMarker"
        type="pattern"
        url="markers/laptop.patt"
        emitevents
        smooth="true" smoothCount="10" smoothTolerance="0.01"
      >
        <a-entity drag-rotate zoomable scale="6 6 6">
          <a-entity
            particle-system="preset: dust; particleCount: 500; size: 0.02"
            position="0 0.2 0"
          ></a-entity>

          <!-- Invisible plane for click; toggled by marker events -->
          <a-plane
            id="laptopClick"
            class="clickable-laptop"
            width="1.5"
            height="1"
            rotation="-90 0 0"
            position="0 0.2 0"
            opacity="0"
            sound="src: #typingSound; on: click; positional: false"
          ></a-plane>

          <a-gltf-model src="#laptopModel"></a-gltf-model>
        </a-entity>
      </a-marker>

      <!-- Camera + cursor (only .clickable-laptop responds) -->
      <a-entity camera look-controls="enabled: false">
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable-laptop"></a-entity>
      </a-entity>
    </a-scene>

     <!-- Toggle laptopClickâ€™s sound component only while its marker is visible -->
    <script>
      const laptopMarker = document.querySelector('#laptopMarker');
      const laptopPlane  = document.querySelector('#laptopClick');

      laptopMarker.addEventListener('markerFound', () => {
        // Restore the sound component when the marker appears
        laptopPlane.setAttribute('sound', 'src: #typingSound; on: click; positional: false');
      });
      laptopMarker.addEventListener('markerLost', () => {
        // Remove the sound component when the marker is gone
        laptopPlane.removeAttribute('sound');
      });
    </script>
  </body>
</html>
