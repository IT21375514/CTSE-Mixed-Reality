<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AR Classroom Enhanced</title>
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        touch-action: none;
      }
    </style>

    <script>
      // Drag-to-rotate
      AFRAME.registerComponent("drag-rotate-3d", {
        init: function () {
          this.dragging = false;
          this.prev = { x: 0, y: 0 };
          const canvas = this.el.sceneEl.canvas;

          const onDown = (e) => {
            this.dragging = true;
            this.prev = { x: e.clientX, y: e.clientY };
          };
          const onUp = () => {
            this.dragging = false;
          };
          const onMove = (e) => {
            if (!this.dragging) return;
            const dx = (e.clientX - this.prev.x) * 0.005;
            const dy = (e.clientY - this.prev.y) * 0.005;
            // yaw left/right
            this.el.object3D.rotation.y += dx;
            // pitch up/down, clamped so you don't flip
            this.el.object3D.rotation.x = THREE.MathUtils.clamp(
              this.el.object3D.rotation.x + dy,
              -Math.PI / 2,
              Math.PI / 2
            );
            this.prev = { x: e.clientX, y: e.clientY };
          };

          canvas.addEventListener("mousedown", onDown);
          window.addEventListener("mouseup", onUp);
          window.addEventListener("mousemove", onMove);
          canvas.addEventListener("touchstart", (ev) => onDown(ev.touches[0]));
          window.addEventListener("touchend", onUp);
          window.addEventListener("touchmove", (ev) => onMove(ev.touches[0]));
        },
      });

      // Zoomable by wheel & pinch
      AFRAME.registerComponent("zoomable", {
        init: function () {
          const obj3D = this.el.object3D;
          const c = this.el.sceneEl.canvas;
          // wheel
          c.addEventListener(
            "wheel",
            (e) => {
              e.preventDefault();
              const f = e.deltaY < 0 ? 1.1 : 0.9;
              obj3D.scale.multiplyScalar(f);
            },
            { passive: false }
          );
          // pinch
          let lastDist = null;
          c.addEventListener("touchmove", (e) => {
            if (e.touches.length !== 2) {
              lastDist = null;
              return;
            }
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const d = Math.hypot(dx, dy);
            if (lastDist) obj3D.scale.multiplyScalar(d / lastDist);
            lastDist = d;
          });
          c.addEventListener("touchend", () => (lastDist = null));
        },
      });

      // Auto-resume audio
      document.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");
        scene.addEventListener("loaded", () => {
          const ctx = scene.systems.sound.context;
          if (ctx && ctx.state === "suspended") ctx.resume();
        });
      });
    </script>
    <!-- 
      <script>
    AFRAME.registerComponent('auto-scale', {
      schema: { desiredSize: { type: 'number', default: 1 } },
      init: function () {
        this.el.addEventListener('model-loaded', (e) => {
          const obj = e.detail.model;                  // THREE.Object3D
          const box = new THREE.Box3().setFromObject(obj);
          const size = new THREE.Vector3();
          box.getSize(size);                           // size.x, size.y, size.z
          const maxAxis = Math.max(size.x, size.y, size.z);
          const scale = this.data.desiredSize / maxAxis;
          obj.scale.set(scale, scale, scale);
        });
      }
    });
  </script> -->

    <!-- <script>
  AFRAME.registerComponent('chucky-behavior', {
    init: function () {
      const marker = document.querySelector('#chuckyMarker');
      const modelEl = this.el;

      marker.addEventListener('markerFound', () => {
        // 1) Jump to starting position
        modelEl.object3D.position.set(0, 0, -2);

        // 2) Play walk animation
        modelEl.setAttribute('animation-mixer', {
          clip: 'walk',
          loop: 'repeat'
        });

        // 3) Trigger the position animation
        modelEl.emit('chuckyWalkStart');
      });

      // Listen for the end of the move animation
      modelEl.addEventListener('animationcomplete', (evt) => {
        if (evt.detail.name === 'walkToMarker') {
          // Switch to stabbing clip once arrived
          modelEl.setAttribute('animation-mixer', {
            clip: 'stab',
            loop: 'repeat'
          });
        }
      });
    }
  });
</script> -->
    <script>
  AFRAME.registerComponent("chucky-behavior", {
    schema: {
      speed: { type: "number", default: 0.005 },    // walking speed per tick
      attackDistance: { type: "number", default: 0.3 } // when to switch to attack
    },
    init() {
      this.marker = document.querySelector("#babyMarker");
      this.babyEl = document.querySelector("#baby");
      this.modelEl = this.el;
      this.walking = false;

      this.onMarkerFound = this.onMarkerFound.bind(this);
      this.marker.addEventListener("markerFound", this.onMarkerFound);
    },
    onMarkerFound() {
      // reset to start 1 unit left of baby
      const babyPos = this.babyEl.object3D.position;
      this.modelEl.object3D.position.set(babyPos.x - 4, babyPos.y, babyPos.z);

      // start walk animation + sound
      this.modelEl.setAttribute("animation-mixer", {
        clip: "Armature|Chucky_WALK_FORWARD",
        loop: "repeat",
        timeScale: 1
      });
      this.modelEl.emit("startWalk");

      this.walking = true;
    },
    tick() {
      if (!this.walking) return;
      const babyPos = this.babyEl.object3D.position;
      const pos  = this.modelEl.object3D.position;
      // compute direction vector toward baby (horizontal only)
      const dx = babyPos.x - pos.x;
      const dz = babyPos.z - pos.z;
      const dist = Math.hypot(dx, dz);
      if (dist < this.data.attackDistance) {
        // close enough: switch to attack
        this.modelEl.setAttribute("animation-mixer", {
          clip: "Armature|Chucky_ATTACK-KNIFE-02",
          loop: "repeat",
          timeScale: 1
        });
        this.walking = false;
        return;
      }
      // move a little toward baby each frame
      pos.x += (dx / dist) * this.data.speed;
      pos.z += (dz / dist) * this.data.speed;
      // optionally rotate Chucky to face the baby
      const angle = Math.atan2(dx, dz) * (180 / Math.PI);
      this.modelEl.object3D.rotation.y = THREE.MathUtils.degToRad(angle);
    },
    remove() {
      this.marker.removeEventListener("markerFound", this.onMarkerFound);
    }
  });
</script>

  </head>

  <body>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false; markersAreaEnabled: true"
      cursor="rayOrigin: mouse"
    >
      <!-- Assets -->
      <a-assets>
        <a-asset-item id="bookModel" src="models/book.glb"></a-asset-item>
        <a-asset-item id="chairModel" src="models/angel.glb"></a-asset-item>
        <a-asset-item id="laptopModel" src="models/laptop.glb"></a-asset-item>
        <a-asset-item id="babyModel" src="models/gregory.glb"></a-asset-item>
        <a-asset-item id="chuckyModel" src="models/chucky.glb"></a-asset-item>

        <audio id="pageSound" src="sounds/page-turn.mp3" preload="auto"></audio>
        <audio
          id="chairSound"
          src="sounds/chair-creak.mp3"
          preload="auto"
        ></audio>
        <audio id="typingSound" src="sounds/typing.mp3" preload="auto"></audio>
        <audio
          id="chuckySound"
          src="sounds/chuckySound.mp3"
          preload="auto"
        ></audio>
        <audio
          id="babySound"
          src="sounds/remusic-scary-loud-screaming-279745.mp3"
          preload="auto"
        ></audio>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient;  intensity: 0.6"></a-entity>
      <a-entity
        light="type: directional; intensity: 0.8"
        position="1 2 1"
      ></a-entity>

      <!-- BOOK marker: page-turn on markerFound -->
      <a-marker
        id="bookMarker"
        type="pattern"
        url="markers/book.patt"
        emitevents
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        sound="src: #pageSound; on: markerFound; positional: false"
      >
        <a-entity drag-rotate-3d zoomable scale="0.001 0.001 0.001">
          <a-gltf-model src="#bookModel"></a-gltf-model>
        </a-entity>
      </a-marker>

      <!-- CHAIR marker: creak on markerFound -->
      <a-marker
        id="chairMarker"
        type="pattern"
        url="markers/ball.patt"
        emitevents
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        sound="src: #chairSound; on: markerFound; positional: false"
      >
        <!-- drag-rotate + zoomable + scale container -->
        <a-entity drag-rotate-3d zoomable scale="12 12 12">
          <!-- your animated model -->
          <a-entity
            gltf-model="#angelModel"
            animation-mixer="clip: anim; loop: repeat; timeScale: 1"
          ></a-entity>
        </a-entity>
      </a-marker>

      <!-- LAPTOP marker: typing on click only -->
      <a-marker
        id="laptopMarker"
        type="pattern"
        url="markers/laptop.patt"
        emitevents
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
      >
        <a-entity drag-rotate-3d zoomable scale="6 6 6">
          <a-entity
            particle-system="preset: dust; particleCount: 500; size: 0.02"
            position="0 0.2 0"
          ></a-entity>

          <!-- Invisible plane for click; toggled by marker events -->
          <a-plane
            id="laptopClick"
            class="clickable-laptop"
            width="1.5"
            height="1"
            rotation="-90 0 0"
            position="0 0.2 0"
            opacity="0"
            sound="src: #typingSound; on: click; positional: false"
          ></a-plane>

          <a-gltf-model src="#laptopModel"></a-gltf-model>
        </a-entity>
      </a-marker>

      <!-- Camera + cursor (only .clickable-laptop responds) -->
      <a-entity camera look-controls="enabled: false">
        <a-entity
          cursor="rayOrigin: mouse"
          raycaster="objects: .clickable-laptop"
        ></a-entity>
      </a-entity>



<!----------------------------------------------------------------------------------------------------------------------->


<a-marker
  id="babyMarker"
  type="pattern"
  url="markers/chair.patt"
  emitevents
  smooth="true"
  smoothCount="10"
  smoothTolerance="0.01"
>
  <!-- Baby sits at origin -->
  <a-entity
    id="baby"
    gltf-model="#babyModel"
    drag-rotate-3d
    zoomable
    scale="2 2 2"
    rotation="-90 0 0"
    position="0 0 0.1"
  >
    <a-sound
      id="babyScream"
      src="#babySound"
      on="markerFound"
      positional="false"
    ></a-sound>
  </a-entity>

  <!-- Chucky follows the baby then attacks -->
  <a-entity
    id="chucky"
    chucky-behavior="speed: 0.08; attackDistance: 0.3"
    drag-rotate-3d
    zoomable
    gltf-model="#chuckyModel"
    scale="0.007 0.007 0.007"   
    rotation="0 0 -90"
    animation="startEvents: startWalk" 
    sound="src: #chuckySound; on: startWalk; positional: false"
  ></a-entity>
</a-marker>


   

    </a-scene>
<!-- 
    <script>
      AFRAME.registerComponent("chucky-behavior", {
        init: function () {
          const marker = document.querySelector("#chuckyMarker");
          const modelEl = this.el;

          // When the marker first appears:
          marker.addEventListener("markerFound", () => {
            // 1) Reset position 2 units back
            modelEl.object3D.position.set(0, 0, -2);
            // 2) Start walk animation
            modelEl.setAttribute("animation-mixer", {
              clip: "Armature|Chucky_WALK_FORWARD",
              loop: "repeat",
              timeScale: 1,
            });
            // 3) Fire event to move forward and play sound
            modelEl.emit("chuckyWalkStart");
          });

          // When the move‐to‐marker animation finishes:
          modelEl.addEventListener("animationcomplete", (evt) => {
            if (evt.detail.name === "walkToMarker") {
              // Switch to attack clip
              modelEl.setAttribute("animation-mixer", {
                clip: "Armature|Chucky_ATTACK-KNIFE-02",
                loop: "repeat",
                timeScale: 1,
              });
            }
          });
        },
      });
    </script> -->

    <!-- Toggle laptopClick’s sound component only while its marker is visible -->
    <script>
      const laptopMarker = document.querySelector("#laptopMarker");
      const laptopPlane = document.querySelector("#laptopClick");

      laptopMarker.addEventListener("markerFound", () => {
        // Restore the sound component when the marker appears
        laptopPlane.setAttribute(
          "sound",
          "src: #typingSound; on: click; positional: false"
        );
      });
      laptopMarker.addEventListener("markerLost", () => {
        // Remove the sound component when the marker is gone
        laptopPlane.removeAttribute("sound");
      });
    </script>
  </body>
</html>
